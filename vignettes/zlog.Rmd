---
title: Z(log) Transformation for Laboratory Measurements
output:
    rmarkdown::html_vignette:
        toc_float: true
vignette: >
    %\VignetteIndexEntry{Z(log) Transformation for Laboratory Measurements}
    %\VignetteEngine{knitr::rmarkdown}
    %\VignetteEncoding{UTF-8}
bibliography: bibliography.bib
---

# Introduction

The `zlog` package offers functions to transform laboratory measurements into
standardised *z* or *z(log)*-values as suggested in @hoffmann2017.
Therefore the lower and upper reference limits are needed. If these are not
known they could estimated from a given sample.

# Z or Z(log) Transformation

Example data and reference limits are taken from @hoffmann2017, Table 2.

```{r zlog}
library("zlog")

albumin <- c(42, 34, 38, 43, 50, 42, 27, 31, 24)
z(albumin, limits = c(35, 52))
zlog(albumin, limits = c(35, 52))
```

# Inverse Z or Z(log) Transformation/Undo Transformation

```{r izlog}
izlog(zlog(albumin, limits = c(35, 52)), limits = c(35, 52))
```

# Estimate Reference Limits

The `reference_limits` functions calculates the lower and upper 2.5 or 97.5
(or a user given probability) quantiles:

```{r reference_limits}
reference_limits(albumin)
reference_limits(albumin, probs = c(0.05, 0.95))

exp(reference_limits(log(albumin)))
```

# Z(log) Dependent Colour Gradient

@hoffmann2017 suggested a colour gradient to visualise laboratory measurements
for the user.

```{r zcol, echo = FALSE, out.width = "95%", fig.width = 10, fig.height = 1, fig.align = "center"}
z <- -10:10
par(mar = c(0, 0, 0, 0), oma = c(0, 0, 0, 0))
image(matrix(z, ncol = 1), col = zcol(z), axes = FALSE)
text(seq(0, 1, length.out=length(z)), 0, label = z)
```

It could be used to highlight the values in a table:

```{r zcoltable, echo = FALSE, result = "asis"}
bilirubin <- c(11, 9, 2, 5, 22, 42, 37, 200, 20)
zloga <- zlog(albumin, limits = c(35, 52))
zlogb <- zlog(bilirubin, limits = c(2, 21))
d <- data.frame(
    Category = c(
        rep(c(
            "blood donor",
            "hepatitis without cirrhosis",
            "hepatitis with cirrhosis"
            ),
            each = 3
        )
    ),
    albumin = albumin,
    zloga = zloga,
    bilirubin = bilirubin,
    zlogb = zlogb
)
d$albumin <- kableExtra::cell_spec(
    d$albumin, background = zcol(zloga), align = "right"
)
d$bilirubin <- kableExtra::cell_spec(
    d$bilirubin, background = zcol(zlogb), align = "right"
)
kableExtra::kable_classic(
    kableExtra::kbl(
        d,
        col.names = c(
            "Category",
            "albumin", "zlog(albumin)", "bilirubin", "zlog(bilirubin)"
        ),
        digits = 2,
        escape = FALSE,
        caption = paste0(
            "Table reproduced from @hoffmann2017, Table 2, limits used: ",
            "albumin 35-52 g/l, bilirubin 2-21 Âµmol/l."
        )
    ),
    "basic"
)
```

# `PBC` Example

For demonstration we choose the `pbc` dataset from the `survival` package
and exclude all non-laboratory measurements except *age* and *sex*:

```{r pbc_load}
library("survival")
data("pbc")
labs <- c(
    "bili", "chol", "albumin", "copper", "alk.phos", "ast", "trig",
    "platelet", "protime"
)
pbc <- pbc[, c("age", "sex", labs)]
knitr::kable(head(pbc), digits = 1)
```

Next we estimate all reference limits from the data:

```{r pbc_reference_limits}
rl <- sapply(pbc[labs], reference_limits)
knitr::kable(rl)
```

Subsequently we can convert the laboratory measurements into *z(log)*-values:

```{r pbc_zlog}
pbc[labs] <- lapply(labs, function(l)zlog(pbc[l], limits = rl[, l]))
```
```{r pbc_table}
pbctbl <- head(pbc, n = 25)
pbctbl[labs] <- lapply(labs, function(l) {
    kableExtra::cell_spec(
        sprintf("%.1f", unlist(pbctbl[l])),
        background = zcol(unlist(pbctbl[l])),
        align = "right"
    )
})

kableExtra::kable_classic(
    kableExtra::kbl(pbctbl, digits = 1, escape = FALSE),
    "basic"
)
```

# Session information

```{r si}
sessionInfo()
```

# References
